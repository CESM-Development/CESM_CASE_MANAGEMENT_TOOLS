#!/bin/csh -fx
### set env variables
setenv CESM2_LE_TOOLS_ROOT $HOME/CESM_CASE_MANAGEMENT_TOOLS

set MACHINE = aleph
set MACHINE = cheyenne
#if ($USER==jedwards)
#set test=test
#else
set test=nanr2
#endif

if ($MACHINE == cheyenne) then
        setenv CESMROOT /glade/work/nanr/cesm_tags/cesm2.1.4-rc.07
        setenv CESM2_LE_TOOLS_ROOT /glade/work/nanr/cesm_tags/CASE_tools/cesm2-le/
        setenv MYROOT /glade/scratch/nanr/
        setenv ARCHDIR /glade/scratch/nanr/archive/
        setenv SCRATCH /glade/scratch/nanr/
else
        setenv CESMROOT /mnt/lustre/share/CESM/cesm2.1.4-rc.07
        setenv CESM2_LE_TOOLS_ROOT $HOME/CESM_CASE_MANAGEMENT_TOOLS
        setenv MYROOT /mnt/lustre/share/CESM
        setenv POSTPROCESS_PATH /home/jedwards/workflow/CESM_postprocessing
        #source $POSTPROCESS_PATH/cesm-env2/bin/activate
        setenv ARCHDIR /mnt/lustre/share/CESM/archive/
        setenv SCRATCH /mnt/lustre/share/CESM/output/
endif


#Start years:  1231, 1251, 1281, 1301


set COMPSET = BHISTcmip6
set RESOLN = f09_g17
set RESUBMIT = 0
set STOP_N=5
set STOP_OPTION=ndays

set smbr =  2
set embr =  2

@ mb = $smbr
@ me = $embr

# years:  1231, 1251, 1281, 1301

foreach mbr ( `seq $mb $me` )

if    ($mbr < 10) then
	setenv CASENAME b.e21.${COMPSET}.${RESOLN}.WK-test.00${mbr}
endif


setenv CASEROOT $SCRATCH/$CASENAME

echo $CASEROOT

# ===================================================================================
# ===================================================================================
#  NOTE:  First member of ensemble creates executable
# ===================================================================================
# ===================================================================================

if ( $mbr == $smbr ) then
  $CESMROOT/cime/scripts/create_newcase --case $CASEROOT --res $RESOLN  --mach $MACHINE --compset $COMPSET --project P93300313

  cd $CASEROOT
  
  ./case.setup
  #mv user_nl_ww   user_nl_ww.`date +%m%d-%H%M`
  #mv user_nl_cam  user_nl_cam.`date +%m%d-%H%M`
  #mv user_nl_clm  user_nl_clm.`date +%m%d-%H%M`
  #mv user_nl_cpl  user_nl_cpl.`date +%m%d-%H%M`
  #mv user_nl_cice user_nl_cice.`date +%m%d-%H%M`
  #mv user_nl_mosart user_nl_mosart.`date +%m%d-%H%M`
  #cp $CESM2_LE_TOOLS_ROOT/user_nl_files/macro-micro-80/user_nl_cam  $CASEROOT/
  #cp $CESM2_LE_TOOLS_ROOT/user_nl_files/macro-micro-80/user_nl_clm  $CASEROOT/
  #cp $CESM2_LE_TOOLS_ROOT/user_nl_files/macro-micro-80/user_nl_cpl  $CASEROOT/
  #cp $CESM2_LE_TOOLS_ROOT/user_nl_files/macro-micro-80/user_nl_cice $CASEROOT/
  #cp $CESM2_LE_TOOLS_ROOT/user_nl_files/macro-micro-80/user_nl_ww   $CASEROOT/
  #cp $CESM2_LE_TOOLS_ROOT/user_nl_files/macro-micro-80/user_nl_mosart $CASEROOT/
  #mv SourceMods SourceMods.`date +%m%d-%H%M`
  #cp -r $CESM2_LE_TOOLS_ROOT/SourceMods $CASEROOT/
#

 
  ./xmlchange RUN_REFCASE=b.e21.B1850.f09_g17.CMIP6-piControl.001
  ./xmlchange RUN_REFDATE=0871-01-01
  ./xmlchange STOP_N=$STOP_N
  ./xmlchange STOP_OPTION=$STOP_OPTION
  ./xmlchange RESUBMIT=$RESUBMIT


  ./preview_namelists
  qcmd -- ./case.build >& bld.`date +%m%d-%H%M`

end             # member loop

exit

