#!/bin/csh -f

set PATH    = /work/06091/nanr/
set COMPSET = BHISTC5
set RESOLN  = ne120_t12
set MACHINE = frontera
set TAG     = cesm-ihesp-hires1.0.30
setenv CESMROOT ${PATH}/cesm_tags/${TAG}/

set mbr = 2
setenv CASE b.e13.${COMPSET}.${RESOLN}.${TAG}-1920-2100.00${mbr}
setenv CASEROOT /work/06091/nanr/frontera/cases/cesm13/$CASE
set RUNDIR   = /scratch1/06091/nanr/$CASE/run

echo $RUNDIR

$CESMROOT/cime/scripts/create_newcase --case $CASEROOT --res $RESOLN  --mach $MACHINE --compset $COMPSET --pecount L --run-unsupported

cd $CASEROOT

./xmlchange NTASKS_CPL=28840
./xmlchange NTASKS_ATM=28800
./xmlchange NTASKS_LND=896
./xmlchange NTASKS_ICE=27944
./xmlchange ROOTPE_ICE=896
./xmlchange NTASKS_OCN=16295
./xmlchange ROOTPE_OCN=28840
./xmlchange NTASKS_ROF=896
./xmlchange NTASKS_GLC=1
./xmlchange NTASKS_WAV=1

./xmlchange RUN_REFCASE=B.E.13.BHISTC5.ne120_t12.sehires38.003.sunway
./xmlchange RUN_REFDATE=1920-01-01
./xmlchange RUN_STARTDATE=1920-01-01
./xmlchange RUN_TYPE=hybrid
./xmlchange GET_REFCASE=TRUE
./xmlchange RUN_REFDIR=ccsm4_init
./xmlchange STOP_OPTION=nyears
./xmlchange STOP_N=4
./xmlchange RESUBMIT=4
./xmlchange DOUT_S_SAVE_INTERIM_RESTART_FILES=TRUE
./xmlchange REST_N=1
./xmlchange REST_OPTION=nyears

./xmlchange --append CAM_CONFIG_OPTS=-cosp

cp /home1/06091/nanr/CESM_tools/ihesp-tools/user_nl_files/BHIST/* $CASEROOT/
cp /home1/06091/nanr/CESM_tools/ihesp-tools/SourceMods/src.pop/*  $CASEROOT/SourceMods/src.pop/

# =========================
# add pertlim perturbation to micro members 2 .. N 
# =========================
if ($mbr != 1) then
cat >> head.${mbr} << EOF

# ! add micro-member perturbation
pertlim = ${mbr}.d-14

EOF

mv user_nl_cam tmp.cam
cat head.${mbr} tmp.cam  > user_nl_cam
rm tmp.cam head.${mbr}

endif
# =========================
# END - pertlim 
# =========================
#

./case.setup --reset
./case.setup
./case.build
