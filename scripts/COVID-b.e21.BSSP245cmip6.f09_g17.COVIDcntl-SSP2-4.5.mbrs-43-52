#!/bin/csh -fx
### set env variables
setenv CESM2_LE_TOOLS_ROOT /glade/work/nanr/cesm_tags/CASE_tools/cesm2-covid/
setenv CESMROOT /glade/work/nanr/cesm_tags/release-cesm2.1.2/

module load intel/17.0.1
module load python/2.7.16
module load graphviz/2.40.1
module load cylc/7.8.3
module load ncarenv/1.3
module load ncarcompilers/0.5.0
module load mpt/2.19
module load netcdf/4.6.3

setenv POSTPROCESS_PATH /glade/u/home/mickelso/CESM_postprocessing_3/
setenv POSTPROCESS_PATH_GEYSER /glade/u/home/mickelso/CESM_postprocessing_3/

set COMPSET = BSSP245cmip6
set SIMULAT = COVIDcntl-SSP2-4.5
set MACHINE = cheyenne
set RESOLN = f09_g17
set RESUBMIT = 1
set STOP_N=3
set STOP_OPTION=nyears

setenv BASEROOT /glade/work/nanr/CESM2-covid/
setenv BASENAME b.e21.${COMPSET}.${RESOLN}.${SIMULAT}

set doThis = 1
if ($doThis == 1) then
cd ~nanr/CESM-WF/
./create_cylc_covid_ensemble-mbrs43-52 --case $BASEROOT$BASENAME --res $RESOLN  --compset $COMPSET --user-mods-dir /glade/u/home/cmip6/cesm_tags/cesm2.1.2-rc.01/components/clm/cime_config/usermods_dirs/cmip6_deck

endif

# .001: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1001.001
# .002: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1021.002
# .003: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1041.003
# .004: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1061.004
# .005: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1081.005
# .006: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1101.006
# .007: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1121.007
# .008: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1141.008
# .009: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1161.009
# .010: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1181.010
###
# .011: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1231.001
# .012: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1231.002
# .013: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1231.003
###
# .014: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1251.001
# .015: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1251.002
# .016: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1251.003
###
# .017: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1281.001
# .018: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1281.002
# .019: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1281.003
###
# .020: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1301.001
# .021: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1301.002
# .022: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1301.003

## OPTION #2
# .023: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1231.004
# .024: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1231.005
# .025: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1231.006
# .026: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1231.007
# .027: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1231.008
###
# .028: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1251.004
# .029: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1251.005
# .030: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1251.006
# .031: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1251.007
# .032: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1251.008
###
# .033: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1281.004
# .034: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1281.005
# .035: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1281.006
# .036: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1281.007
# .037: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1281.008
###
# .038: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1301.004
# .039: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1301.005
# .040: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1301.006
# .041: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1301.007
# .042: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1301.008
###
# .043: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1231.009
# .044: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1231.010
###
# .045: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1251.009
# .046: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1251.010
###
# .047: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1281.009
# .048: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1281.010
###
# .049: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1301.009
# .050: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1301.010
###
# .051: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1011.001
# .052: RUN_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-1031.002

# now create cases

set smbr =  43
set embr =  52
set offset = 9

@ mb = $smbr
@ me = $embr

@ basembr = 1
@ ctr = 1
@ casectr = $offset



foreach mbr ( `seq $mb  $me` )

#  advance reference case every 4th member
@ rmndr = $ctr % 2

if ($mbr < 45) then
        set REFDATE = 1231
        set usecasectr = $casectr
endif
if ($mbr >= 45 && $mbr < 47) then
        set REFDATE = 1251
        set usecasectr = $casectr
endif
if ($mbr >= 47 && $mbr < 49) then
        set REFDATE = 1281
        set usecasectr = $casectr
endif
if ($mbr >= 49 && $mbr < 51) then
        set REFDATE = 1301
        set usecasectr = $casectr
endif
if ($mbr == 51 ) then
        set REFDATE = 1001
        set usecasectr = 1
endif
if ($mbr == 52 ) then
        set REFDATE = 1021
        set usecasectr = 2
endif


if    ($usecasectr < 10) then
        #setenv REFCASE  b.e21.BHISTcmip6.f09_g17.LE2-1231.00${casectr}
        setenv REFCASE  b.e21.BHISTcmip6.${RESOLN}.LE2-${REFDATE}.00${usecasectr}
else if ($usecasectr >= 10 && $usecasectr < 100) then
        #setenv REFCASE  b.e21.BHISTcmip6.f09_g17.LE2-1231.0${casectr}
        setenv REFCASE  b.e21.BHISTcmip6.${RESOLN}.LE2-${REFDATE}.0${usecasectr}
endif

if    ($mbr < 10) then
        setenv CASENAME b.e21.${COMPSET}.${RESOLN}.${SIMULAT}.00${mbr}
else if ($mbr >= 10 && $mbr < 100) then
        setenv CASENAME b.e21.${COMPSET}.${RESOLN}.${SIMULAT}.0${mbr}
endif

#echo $CASENAME
#echo $REFCASE

if ($doThis == 1) then

  setenv REFROOT   /glade/scratch/nanr/archive/$REFCASE/rest/2015-01-01-00000/
  setenv RUNROOT   /glade/scratch/nanr/$CASENAME/run/
  setenv CASEROOT  $BASEROOT$CASENAME

  cd $CASEROOT


# 20 nodes
  ./xmlchange NTASKS_CPL=576
  ./xmlchange NTASKS_ATM=576
  ./xmlchange NTASKS_LND=504
  ./xmlchange NTASKS_ICE=36
  ./xmlchange NTASKS_OCN=144
  ./xmlchange NTASKS_ROF=468
  ./xmlchange NTASKS_GLC=576
  ./xmlchange NTASKS_WAV=36
  ./xmlchange ROOTPE_ICE=504
  ./xmlchange ROOTPE_OCN=576
  ./xmlchange ROOTPE_WAV=540

  mv user_nl_cam user_nl_cam.`date +%m%d-%H%M`
  mv user_nl_clm user_nl_clm.`date +%m%d-%H%M`
  mv user_nl_cpl user_nl_cpl.`date +%m%d-%H%M`
  mv user_nl_cice user_nl_cice.`date +%m%d-%H%M`

  cp $CESM2_LE_TOOLS_ROOT/user_nl_files/SSP245-forcing/user_nl_cam $CASEROOT/
  cp $CESM2_LE_TOOLS_ROOT/user_nl_files/SSP245-forcing/user_nl_clm $CASEROOT/
  cp $CESM2_LE_TOOLS_ROOT/user_nl_files/SSP245-forcing/user_nl_cpl $CASEROOT/
  cp $CESM2_LE_TOOLS_ROOT/user_nl_files/SSP245-forcing/user_nl_cice $CASEROOT/

  ./case.setup --reset
  ./case.setup

  ./xmlchange RUN_REFCASE=$REFCASE
  ./xmlchange GET_REFCASE=FALSE
  ./xmlchange RUN_REFDATE=2015-01-01
  ./xmlchange STOP_N=$STOP_N
  ./xmlchange STOP_OPTION=$STOP_OPTION
  ./xmlchange RESUBMIT=$RESUBMIT

  cp $REFROOT/rpoint*   $RUNROOT/
  ln -s $REFROOT/b.e21* $RUNROOT/

  ./preview_namelists

endif

  @ casectr ++

  # advance REFCASE after every 5th ensemble member
  if ($rmndr == 0) then
        @ basembr ++
	@ casectr = $offset
        @ REFDATE ++
  endif
  @ ctr ++


# ./case.build >& bld.`date +%m%d-%H%M`
end             # member loop

exit

