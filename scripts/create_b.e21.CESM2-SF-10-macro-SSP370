#!/bin/csh -fx
### set env variables
setenv CESM2_LE_TOOLS_ROOT /glade/work/nanr/cesm_tags/CASE_tools/cesm2-sf/
setenv CESMROOT ~cmip6/cesm_tags/release-cesm2.1.2/
setenv CESMROOT ~cmip6/cesm_tags/cesm2.1.4-exp02/

module load intel/17.0.1
module load python/2.7.16
module load graphviz/2.40.1
module load cylc/7.8.3
module load ncarenv/1.3
module load ncarcompilers/0.5.0
module load mpt/2.19
module load netcdf/4.6.3

setenv POSTPROCESS_PATH /glade/u/home/mickelso/CESM_postprocessing_3/
setenv POSTPROCESS_PATH_GEYSER /glade/u/home/mickelso/CESM_postprocessing_3/

set COMPSET = BSSP370cmip6
set MACHINE = cheyenne
set RESOLN = f09_g17
set RESUBMIT = 0
set STOP_N=40
set STOP_OPTION=nyears

set smbr =  1
set embr =  1

@ mb = $smbr
@ me = $embr

foreach mbr ( `seq $mb  $me` )


if    ($mbr < 10) then
	setenv CASENAME b.e21.${COMPSET}.${RESOLN}.CMIP6-SSP3-7.0.10${mbr}
else if ($mbr >= 10 && $mbr < 100) then
	setenv CASENAME b.e21.${COMPSET}.${RESOLN}.CMIP6-SSP3-7.0.1${mbr}
endif

# .001: RUN_REFCASE=b.e21.BHIST.f09_g17.CMIP6-historical.010 (piCntl=y841)
# .002: RUN_REFCASE=b.e21.BHIST.f09_g17.CMIP6-historical.011 (piCntl=y871)
# .003: RUN_REFCASE=b.e21.BHIST.f09_g17.CMIP6-historical.004 (piCntl=y501)

setenv CASEROOT /glade/work/nanr/cmip6/cases/ScenarioMIP/$CASENAME
cd ~cmip6/nanr/CESM-WF/
./create_cylc_b.e21.BSSP-std-as-nanr --case $CASEROOT --res $RESOLN  --compset $COMPSET --user-mods-dir /glade/u/home/cmip6/cesm_tags/cesm2.1.2-rc.01/components/clm/cime_config/usermods_dirs/cmip6_deck
  
  cd $CASEROOT

  ./xmlchange NTASKS_CPL=1152
  ./xmlchange NTASKS_ATM=1152
  ./xmlchange NTASKS_LND=792
  ./xmlchange NTASKS_ICE=360
  ./xmlchange NTASKS_OCN=512
  ./xmlchange NTASKS_ROF=792
  ./xmlchange NTASKS_GLC=1152
  ./xmlchange NTASKS_WAV=28
  ./xmlchange NTHRDS_CPL=3
  ./xmlchange NTHRDS_ATM=3
  ./xmlchange NTHRDS_LND=3
  ./xmlchange NTHRDS_ICE=3
  ./xmlchange NTHRDS_OCN=3
  ./xmlchange NTHRDS_ROF=3
  ./xmlchange NTHRDS_GLC=3
  ./xmlchange NTHRDS_WAV=3
  ./xmlchange ROOTPE_ICE=792
  ./xmlchange ROOTPE_OCN=1152
  ./xmlchange ROOTPE_WAV=1664


  mv user_nl_cam user_nl_cam.`date +%m%d-%H%M`
  mv user_nl_clm user_nl_clm.`date +%m%d-%H%M`
  mv user_nl_cpl user_nl_cpl.`date +%m%d-%H%M`
  mv user_nl_cice user_nl_cice.`date +%m%d-%H%M`

  # MOAR
  if ($mbr == 2) then
        mv user_nl_mosart user_nl_mosart.`date +%m%d-%H%M`
  	cp $CESM2_LE_TOOLS_ROOT/user_nl_files/ScenarioMIP/moar/user_nl_cam $CASEROOT/
  	cp $CESM2_LE_TOOLS_ROOT/user_nl_files/ScenarioMIP/moar/user_nl_clm $CASEROOT/
  	cp $CESM2_LE_TOOLS_ROOT/user_nl_files/ScenarioMIP/moar/user_nl_cpl $CASEROOT/
  	cp $CESM2_LE_TOOLS_ROOT/user_nl_files/ScenarioMIP/moar/user_nl_cice $CASEROOT/
  	cp $CESM2_LE_TOOLS_ROOT/user_nl_files/ScenarioMIP/moar/user_nl_mosart $CASEROOT/
  	cp $CESM2_LE_TOOLS_ROOT/user_nl_files/ScenarioMIP/moar/user_nl_ww $CASEROOT/
  else
  	cp $CESM2_LE_TOOLS_ROOT/user_nl_files/ScenarioMIP/user_nl_cam $CASEROOT/
  	cp $CESM2_LE_TOOLS_ROOT/user_nl_files/ScenarioMIP/user_nl_clm $CASEROOT/
  	cp $CESM2_LE_TOOLS_ROOT/user_nl_files/ScenarioMIP/user_nl_cpl $CASEROOT/
  	cp $CESM2_LE_TOOLS_ROOT/user_nl_files/ScenarioMIP/user_nl_cice $CASEROOT/
  	cp $CESM2_LE_TOOLS_ROOT/user_nl_files/ScenarioMIP/user_nl_ww $CASEROOT/
  endif

  if ($mbr == 1) then
                ./xmlchange RUN_REFCASE=b.e21.BHIST.f09_g17.CMIP6-historical.010_v2
               # remove use_init_interp = .true.
                cp $CESM2_LE_TOOLS_ROOT/user_nl_files/ScenarioMIP/user_nl_clm_v2 $CASEROOT/user_nl_clm

  else
  if ($mbr == 2) then
                ./xmlchange RUN_REFCASE=b.e21.BHIST.f09_g17.CMIP6-historical.011
		./xmlchange --append CAM_CONFIG_OPTS=-cosp
  else
  if ($mbr == 3) then
                ./xmlchange RUN_REFCASE=b.e21.BHIST.f09_g17.CMIP6-historical.004
  endif
  endif
  endif

  ./case.setup

  ./xmlchange RUN_REFDATE=2015-01-01
  ./xmlchange STOP_N=$STOP_N
  ./xmlchange STOP_OPTION=$STOP_OPTION
  ./xmlchange RESUBMIT=$RESUBMIT

  ./preview_namelists

# ./case.build >& bld.`date +%m%d-%H%M`
end             # member loop

exit

