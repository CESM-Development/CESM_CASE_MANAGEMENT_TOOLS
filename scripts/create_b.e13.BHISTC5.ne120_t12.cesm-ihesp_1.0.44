#!/bin/csh -f

set PATH    = /work/06091/nanr/
set COMPSET = BHISTC5
set RESOLN  = ne120_t12
set MACHINE = frontera
set TAG     = cesm-ihesp-hires1.0.30
set TAG     = cesm-ihesp-hires1.0.44
set mbr     = 4

setenv REFCASE B.E.13.BHISTC5.ne120_t12.sehires38.003.sunway
setenv CASE b.e13.${COMPSET}.${RESOLN}.${TAG}-1920-2005.00${mbr}

if ($MACHINE == frontera) then
        set PATH      = $STOCKYARD
        set RUNDIR    = $SCRATCH/$CASE/run
        set BLDDIR    = $SCRATCH/$CASE/bld
        set CASEROOT  = $STOCKYARD/frontera/cases/cesm13/$CASE
        set TOOLSROOT = $HOME/CESM_tools/ihesp-tools/
        set REFROOT   = /scratch1/06090/fredc/inputdata/BHIST/$REFCASE/rest/1920-01-01-00000
        set REFROOT   = /work2/02503/edwardsj/CESM/inputdata/ccsm4_init/$REFCASE/1920-01-01-00000
        setenv CESMROOT ${STOCKYARD}/cesm_tags/${TAG}/
else 
        set PATH      = /glade/work/nanr/
        set RUNDIR    = /glade/scratch/nanr/$CASE/run
        set BLDDIR    = /glade/scratch/nanr/$CASE/bld
        set CASEROOT  = /glade/work/nanr/ihesp-HiRes/cases/ne120_t12/$CASE
        set TOOLSROOT = /glade/work/nanr/cesm_tags/CASE_tools/ihesp-tools/
        set REFROOT   = /glade/scratch/nanr/archive/$REFCASE/rest/2006-01-01-00000
        setenv CESMROOT /glade/work/nanr/cesm_tags/${TAG}/
endif

echo $RUNDIR

$CESMROOT/cime/scripts/create_newcase --case $CASEROOT --res $RESOLN  --mach $MACHINE --compset $COMPSET --pecount L --run-unsupported

cd $CASEROOT

./xmlchange NTASKS_CPL=28840
./xmlchange NTASKS_ATM=28800
./xmlchange NTASKS_LND=896
./xmlchange NTASKS_ICE=27944
./xmlchange ROOTPE_ICE=896
./xmlchange NTASKS_OCN=16295
./xmlchange ROOTPE_OCN=28840
./xmlchange NTASKS_ROF=896
./xmlchange NTASKS_GLC=1
./xmlchange NTASKS_WAV=1

./xmlchange RUN_REFCASE=$REFCASE
./xmlchange RUN_REFDATE=1920-01-01
./xmlchange RUN_STARTDATE=1920-01-01
./xmlchange RUN_TYPE=hybrid
./xmlchange GET_REFCASE=TRUE
./xmlchange RUN_REFDIR=ccsm4_init
./xmlchange STOP_OPTION=nyears
./xmlchange STOP_N=4
./xmlchange RESUBMIT=4
./xmlchange DOUT_S_SAVE_INTERIM_RESTART_FILES=TRUE
./xmlchange REST_N=1
./xmlchange REST_OPTION=nyears

./xmlchange --append CAM_CONFIG_OPTS=-cosp

cp $TOOLSROOT/user_nl_files/BHIST/* $CASEROOT/
cp $TOOLSROOT/SourceMods/src.pop/iPOGS/*  $CASEROOT/SourceMods/src.pop/

# =========================
# add pertlim perturbation to micro members 2 .. N 
# =========================
if ($mbr != 1) then
cat >> head.${mbr} << EOF

! add micro-member perturbation
pertlim = ${mbr}.d-14

EOF

mv user_nl_cam tmp.cam
cat head.${mbr} tmp.cam  > user_nl_cam
rm tmp.cam head.${mbr}

endif
# =========================
# END - pertlim 
# =========================
#

./case.setup --reset
./case.setup
./case.build
