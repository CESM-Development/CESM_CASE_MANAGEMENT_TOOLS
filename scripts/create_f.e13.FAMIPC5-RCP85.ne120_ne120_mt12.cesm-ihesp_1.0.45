#!/bin/csh -f

set MACHINE = stampede2

set COMPSET = FAMIPC5
set RESOLN  = ne120_ne120_mt12
set TAG     = cesm-ihesp-hires1.0.44

#set RESUBMIT = 1
#set STOP_OPTION=nmonths
#set STOP_N=31
set RESUBMIT = 0
set STOP_OPTION=nyears
set STOP_N=5
set REST_OPTION=nmonths
set REST_N=6

set smbr =  1
set embr =  1

@ mb = $smbr
@ me = $embr

foreach mbr  ( `seq $mb  $me` )

if ($mbr < 10) then
	setenv CASE f.e13.${COMPSET}.${RESOLN}.DECK_1950TR_RCP85.00${mbr}
else
	setenv CASE f.e13.${COMPSET}.${RESOLN}.DECK_1950TR_RCP85.0${mbr}
endif
setenv REFCASE ${CASE}

if ($MACHINE == frontera) then
	set PATH      = $STOCKYARD
	set RUNDIR    = $SCRATCH/$CASE/run
	set BLDDIR    = $SCRATCH/$CASE/bld
	set CASEROOT  = $STOCKYARD/frontera/cases/cesm13/$CASE
        set TOOLSROOT = $HOME/CESM_tools/ihesp-tools/
        set REFROOT   = /work2/02503/edwardsj/CESM/inputdata/ccsm4_init/
else if ($MACHINE == stampede2) then
	set PATH      = $STOCKYARD
	set RUNDIR    = $SCRATCH/$CASE/run
	set BLDDIR    = $SCRATCH/$CASE/bld
	set CASEROOT  = $STOCKYARD/stampede2/cases/cesm13/$CASE
        set TOOLSROOT = $HOME/CESM_tools/ihesp-tools/
        set REFROOT   = /scratch/06091/nanr/archive/
else if ($MACHINE == cheyenne ) then
	set PATH      = /glade/work/nanr/
	set RUNDIR    = /glade/scratch/nanr/$CASE/run
	set BLDDIR    = /glade/scratch/nanr/$CASE/bld
	setenv CASEROOT /glade/work/nanr/ihesp-HiRes/cases/ne120_ne120_mt12/$CASE
        set TOOLSROOT = /glade/work/nanr/cesm_tags/CASE_tools/ihesp-tools/
        set REFROOT   = /glade/scratch/nanr/archive/
endif

setenv CESMROOT ${PATH}/cesm_tags/${TAG}/


# $CESMROOT/cime/scripts/create_newcase --case $CASEROOT --res $RESOLN  --mach $MACHINE --compset $COMPSET --pecount L --run-unsupported
$CESMROOT/cime/scripts/create_newcase --case $CASEROOT --res $RESOLN  --compset $COMPSET --pecount L --run-unsupported

cd $CASEROOT

if ($MACHINE == frontera ) then
   ./xmlchange NTASKS=21616
endif
if ($MACHINE == stampede2 ) then
    ./xmlchange NTASKS=-128
endif
if ($MACHINE == cheyenne ) then
  #./xmlchange NTASKS=-7200
   ./xmlchange NTASKS=14400
endif

./xmlchange RESUBMIT=$RESUBMIT
./xmlchange STOP_OPTION=$STOP_OPTION
./xmlchange RUN_TYPE=hybrid
./xmlchange RUN_STARTDATE=2006-01-01
./xmlchange RUN_REFCASE=${REFCASE}
./xmlchange RUN_REFDATE=2006-01-01
./xmlchange GET_REFCASE=FALSE
./xmlchange ICE_DOMAIN_FILE=domain.ocn.ne120np4_tx0.1v2.191122.nc
./xmlchange OCN_DOMAIN_FILE=domain.ocn.ne120np4_tx0.1v2.191122.nc
./xmlchange --append CAM_CONFIG_OPTS=-cosp

./xmlchange SSTICE_YEAR_ALIGN=1950
./xmlchange SSTICE_YEAR_START=1950
./xmlchange SSTICE_YEAR_END=2050
./xmlchange CONTINUE_RUN=TRUE


if ($MACHINE == frontera || $MACHINE == stampede2 ) then
	./xmlchange JOB_WALLCLOCK_TIME=2:00:00 --subgroup case.st_archive
	./xmlchange JOB_WALLCLOCK_TIME=26:00:00 --subgroup case.run
	./xmlchange STOP_N=10
        ./xmlchange SSTICE_GRID_FILENAME=/work2/06091/nanr/frontera/SST-highres/domain.ocn.0.25x0.25_mask.181109.nc   
        ./xmlchange SSTICE_GRID_FILENAME=/work2/06091/nanr/frontera/SST-highres/domain.ocn.0.25x0.25_mask.181109.nc   
	#cp $TOOLSROOT/user_nl_files/DP-HR/user_nl_cam-COSP-ON $CASEROOT/user_nl_cam
	cp $TOOLSROOT/user_nl_files/AMIP-RCP85-1950-2050-highRes-DECK-pftdyn/stampede/user_* $CASEROOT/
        if ( $MACHINE == stampede2 ) then
		./xmlchange DOUT_S_ROOT=\$CIME_OUTPUT_ROOT/archive/$CASE
        endif
endif

if ($MACHINE == cheyenne) then
        ./xmlchange PROJECT=CESM0021
	./xmlchange STOP_N=10
        ./xmlchange SSTICE_GRID_FILENAME=/glade/work/nanr/ihesp-HiRes/SST-highres/domain/domain.ocn.0.25x0.25_mask.181109.nc
	##cp $TOOLSROOT/user_nl_files/DP-HR/user_nl_cam-COSP-ON $CASEROOT/user_nl_cam
	cp $TOOLSROOT/user_nl_files/AMIP-1950-2050-highRes-DECK-pftdyn/cheyenne/user_* $CASEROOT/*
endif


#cp $TOOLSROOT/SourceMods/src.cice/AMIP-1950-2050-highRes-pftdyn/cheyenne/*  $CASEROOT/SourceMods/src.cice/
#cp $TOOLSROOT/SourceMods/src.pop/AMIP-1950-2050-highRes-pftdyn/cheyenne/*  $CASEROOT/SourceMods/src.pop/
cp $TOOLSROOT/SourceMods/src.cam/*F90  $CASEROOT/SourceMods/src.cam/


echo "================="
echo $REFROOT/$REFCASE/
echo "================="

./case.setup

cp    $REFROOT/$REFCASE/$REFDATE-01-01-00000/rpoint* $RUNDIR
ln -s $REFROOT/$REFCASE/$REFDATE-01-01-00000/$REFCASE* $RUNDIR

if ($MACHINE == frontera || $MACHINE == stampede2 ) then
	./case.setup --reset; 
	./case.build
else
	./case.setup --reset; 
	qcmd -- ./case.build
endif

end
