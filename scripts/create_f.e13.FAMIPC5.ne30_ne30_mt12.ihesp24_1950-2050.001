#!/bin/csh -f
### set env variables


## We need to create
set COMPSET = FAMIPC5
set RESOLN  = ne30_ne30_mt12
set MACHINE = cheyenne
set MACHINE = frontera
set TAG     = cesm-ihesp-hires1.0.34

set mbr = 1
setenv CASE f.e13.${COMPSET}.${RESOLN}.${TAG}_1950-2050.00${mbr}

if ($MACHINE == frontera) then
        set PATH      = $STOCKYARD
        set RUNDIR    = $SCRATCH/$CASE/run
        set BLDDIR    = $SCRATCH/$CASE/bld
        set CASEROOT  = $STOCKYARD/frontera/cases/cesm13/$CASE
        set TOOLSROOT = $HOME/CESM_tools/ihesp-tools/
        set REFROOT   = /scratch1/06091/nanr/DP-HR/inputdata/cesm2_init/
	setenv CESMROOT /gpfs/fs1/work/nanr/cesm_tags/cesm-ihesp-hires1.0.24/
else 
        set PATH      = /glade/work/nanr/
        set RUNDIR    = /glade/scratch/nanr/$CASE/run
        set BLDDIR    = /glade/scratch/nanr/$CASE/bld
        setenv CASEROOT /glade/work/nanr/ihesp-HiRes/cases/ne120_t12/$CASE
        set TOOLSROOT = /glade/work/nanr/cesm_tags/CASE_tools/ihesp-tools/
        set REFROOT   = /glade/scratch/nanr/DP-HR/inputdata/cesm2_init/
endif

setenv CESMROOT ${PATH}/cesm_tags/${TAG}/

# $CESMROOT/scripts/create_newcase -case $CASEROOT -res $RESOLN  -mach $MACHINE -compset $COMPSET -compiler $COMPILER
  $CESMROOT/cime/scripts/create_newcase --case $CASEROOT --res $RESOLN  --mach $MACHINE --compset $COMPSET --run-unsupported

cd $CASEROOT

### modify case parameters
./xmlchange RUN_TYPE=hybrid
./xmlchange STOP_OPTION=nyears
./xmlchange RUN_STARTDATE=1950-01-01
./xmlchange RUN_REFCASE=b.e13.B1950C5.ne30_g16.cesm-ihesp-NCPL-CESM1_MOD-ROF2OCN_RMAP_1950cntl.01
./xmlchange RUN_REFDATE=0031-01-01
./xmlchange STOP_N=5
./xmlchange GET_REFCASE=FALSE
./xmlchange DIN_LOC_ROOT='/glade/p/cesm/cseg/inputdata'
./xmlchange DIN_LOC_ROOT_CLMFORC='/glade/p/cesm/cseg/inputdata/atm/datm7'


 ./xmlchange --append CAM_CONFIG_OPTS=-cosp

 ./xmlchange RUNDIR='/glade/scratch/nanr/$CASE/run'
 ./xmlchange EXEROOT='/glade/scratch/nanr/$CASE/bld'

 ./xmlchange ATM_DOMAIN_FILE=domain.lnd.ne30np4_mt12.200214.nc
 ./xmlchange LND_DOMAIN_FILE=domain.lnd.ne30np4_mt12.200214.nc
 ./xmlchange ICE_DOMAIN_FILE=domain.ocn.ne30np4_mt12.200214.nc
 ./xmlchange OCN_DOMAIN_FILE=domain.ocn.ne30np4_mt12.200214.nc

 if ($machine == frontera) then
 	./xmlchange ATM_DOMAIN_PATH=/work2/06091/nanr/frontera/SST-highres/
 	./xmlchange LND_DOMAIN_PATH=/work2/06091/nanr/frontera/SST-highres/
 	./xmlchange OCN_DOMAIN_PATH=/work2/06091/nanr/frontera/SST-highres/
 	./xmlchange ICE_DOMAIN_PATH=/work2/06091/nanr/frontera/SST-highres/
 	./xmlchange SSTICE_GRID_FILENAME=/work2/06091/nanr/frontera/SST-highres/domain.ocn.0.25x0.25_mask.181109.nc
 else
 	./xmlchange NTASKS_ATM=2160
 	./xmlchange NTASKS_LND=2160
 	./xmlchange NTASKS_ICE=2160
 	./xmlchange NTASKS_OCN=2160
 	./xmlchange NTASKS_CPL=2160
 	./xmlchange NTASKS_ROF=2160
 	./xmlchange ATM_DOMAIN_PATH=/glade/work/nanr/ihesp-HiRes/SST-highres/domain/
 	./xmlchange LND_DOMAIN_PATH=/glade/work/nanr/ihesp-HiRes/SST-highres/domain/
 	./xmlchange OCN_DOMAIN_PATH=/glade/work/nanr/ihesp-HiRes/SST-highres/domain/
 	./xmlchange ICE_DOMAIN_PATH=/glade/work/nanr/ihesp-HiRes/SST-highres/domain/
 	./xmlchange SSTICE_GRID_FILENAME=/glade/work/nanr/ihesp-HiRes/SST-highres/domain/domain.ocn.0.25x0.25_mask.181109.nc
 endif
 ./xmlchange SSTICE_YEAR_ALIGN=1950
 ./xmlchange SSTICE_YEAR_START=1950
 ./xmlchange SSTICE_YEAR_END=2050

./case.setup

mv user_nl_cam user_nl_cam.`date +%m%d-%H%M`
mv user_nl_clm user_nl_clm.`date +%m%d-%H%M`
mv user_nl_cice user_nl_cice.`date +%m%d-%H%M`

cp /glade/work/nanr/cesm_tags/CASE_tools/ihesp-tools/user_nl_files/AMIP-1950-2050-lowRes/* $CASEROOT
cp /glade/work/nanr/cesm_tags/CASE_tools/ihesp-tools/SourceMods/src.cam/* $CASEROOT/SourceMods/src.cam/
#cp /glade/work/nanr/cesm_tags/CASE_tools/ihesp-tools/SourceMods/src.clm/ne30_ne30_mt12-ONLY/* $CASEROOT/SourceMods/src.clm/

cp /glade/p/cesmdata/cseg/inputdata/ccsm4_init/b.e13.B1950C5.ne30_g16.cesm-ihesp-NCPL-CESM1_MOD-ROF2OCN_RMAP_1950cntl.01/0031-01-01/* /glade/scratch/nanr/$CASE/run

#qcmd -- ./case.build
