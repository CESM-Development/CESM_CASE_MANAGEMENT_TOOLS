#!/bin/csh -fx
### set env variables
setenv CESM2_LE_TOOLS_ROOT /glade/work/nanr/cesm_tags/CASE_tools/cesm2-le/
#if ($USER==jedwards)
#set test=test
#else
set test=
#endif

#Start years:  1231, 1251, 1281, 1301

setenv CESMROOT ~cmip6/cesm_tags/release-cesm2.1.2/

set COMPSET = BSSP370cmip6
set MACHINE = cheyenne
set RESOLN = f09_g17
set RESUBMIT = 1
set STOP_N=10
set STOP_OPTION=nyears

set rootmbr =  1

set smbr =  1
set embr =  10

@ mb = $smbr
@ me = $embr

# years:  1231, 1251, 1281, 1301

foreach mbr ( `seq $mb $me` )
@ USE_REFDATE = 1231 


if    ($mbr < 10) then
	setenv CASENAME b.e21${test}.${COMPSET}.${RESOLN}.LE2-${USE_REFDATE}.00${mbr}
        set USE_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-${USE_REFDATE}.00${mbr}
else if ($mbr >= 10 && $mbr < 100) then
	setenv CASENAME b.e21${test}.${COMPSET}.${RESOLN}.LE2-${USE_REFDATE}.0${mbr}
        set USE_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-${USE_REFDATE}.0${mbr}
else
	setenv CASENAME b.e21${test}.${COMPSET}.${RESOLN}.LE2-${USE_REFDATE}.${mbr}
        set USE_REFCASE=b.e21.BHISTcmip6.f09_g17.LE2-${USE_REFDATE}.${mbr}
endif
setenv CASEROOT /glade/work/nanr/CESM2-LE/ScenarioMIP/$CASENAME

# ===================================================================================
# specify master executable
# ===================================================================================
if    ($rootmbr < 10) then
	set    ROOTNAME=b.e21${test}.${COMPSET}.${RESOLN}.LE2-${USE_REFDATE}.00${rootmbr}
else if ($rootmbr >= 10 && $rootmbr < 100) then
	set    ROOTNAME=b.e21${test}.${COMPSET}.${RESOLN}.LE2-${USE_REFDATE}.0${rootmbr}
else
	set    ROOTNAME=b.e21${test}.${COMPSET}.${RESOLN}.LE2-${USE_REFDATE}.${rootmbr}
endif

setenv masterroot /glade/work/nanr/CESM2-LE/ScenarioMIP/$ROOTNAME


echo $CASEROOT
echo $masterroot

# ===================================================================================
# ===================================================================================
#  NOTE:  First member of ensemble creates executable
# ===================================================================================
# ===================================================================================

if ( $mbr == $rootmbr ) then
  $CESMROOT/cime/scripts/create_newcase --case $CASEROOT --res $RESOLN  --mach $MACHINE --compset $COMPSET 
  cd $CASEROOT

  ./xmlchange NTASKS_CPL=1152
  ./xmlchange NTASKS_ATM=1152
  ./xmlchange NTASKS_LND=792
  ./xmlchange NTASKS_ICE=360
  ./xmlchange NTASKS_OCN=512
  ./xmlchange NTASKS_ROF=792
  ./xmlchange NTASKS_GLC=1152
  ./xmlchange NTASKS_WAV=28
  ./xmlchange NTHRDS_CPL=3
  ./xmlchange NTHRDS_ATM=3
  ./xmlchange NTHRDS_LND=3
  ./xmlchange NTHRDS_ICE=3
  ./xmlchange NTHRDS_OCN=3
  ./xmlchange NTHRDS_ROF=3
  ./xmlchange NTHRDS_GLC=3
  ./xmlchange NTHRDS_WAV=3
  ./xmlchange ROOTPE_ICE=792
  ./xmlchange ROOTPE_OCN=1152
  ./xmlchange ROOTPE_WAV=1664

  
  ./case.setup
  mv user_nl_ww   user_nl_ww.`date +%m%d-%H%M`
  mv user_nl_cam  user_nl_cam.`date +%m%d-%H%M`
  mv user_nl_clm  user_nl_clm.`date +%m%d-%H%M`
  mv user_nl_cpl  user_nl_cpl.`date +%m%d-%H%M`
  mv user_nl_cice user_nl_cice.`date +%m%d-%H%M`
  mv user_nl_mosart user_nl_mosart.`date +%m%d-%H%M`
  cp $CESM2_LE_TOOLS_ROOT/user_nl_files/macro-micro-80/NWSC/user_nl_cam-SSP370  $CASEROOT/user_nl_cam
  cp $CESM2_LE_TOOLS_ROOT/user_nl_files/macro-micro-80/NWSC/user_nl_clm  $CASEROOT/
  cp $CESM2_LE_TOOLS_ROOT/user_nl_files/macro-micro-80/NWSC/user_nl_cpl  $CASEROOT/
  cp $CESM2_LE_TOOLS_ROOT/user_nl_files/macro-micro-80/NWSC/user_nl_cice $CASEROOT/
  cp $CESM2_LE_TOOLS_ROOT/user_nl_files/macro-micro-80/NWSC/user_nl_ww   $CASEROOT/
  cp $CESM2_LE_TOOLS_ROOT/user_nl_files/macro-micro-80/NWSC/user_nl_mosart $CASEROOT/
  mv SourceMods SourceMods.`date +%m%d-%H%M`
  cp -r $CESM2_LE_TOOLS_ROOT/SourceMods $CASEROOT/

  cp     /glade/scratch/nanr/archive/${USE_REFCASE}/rest/2015-01-01-00000/rpointer* /glade/scratch/nanr/${CASENAME}/run/
  ln -s  /glade/scratch/nanr/archive/${USE_REFCASE}/rest/2015-01-01-00000/b.e21.BHISTcmip6.* /glade/scratch/nanr/${CASENAME}/run/.
 
  ./xmlchange RUN_REFCASE=${USE_REFCASE}
  ./xmlchange RUN_REFDATE=2015-01-01
  ./xmlchange STOP_N=$STOP_N
  ./xmlchange STOP_OPTION=$STOP_OPTION
  ./xmlchange RESUBMIT=$RESUBMIT
  ./xmlchange DOUT_S_ROOT=/glade/scratch/nanr/$CASENAME
  ./xmlchange GET_REFCASE=FALSE
  ./xmlchange JOB_QUEUE=economy --subgroup case.run
  ./xmlchange PROJECT=CESM0005


  ./preview_namelists
  qcmd -- ./case.build >& bld.`date +%m%d-%H%M`

# ===================================================================================
# ===================================================================================
# NOTE:  Ensemble members 2-10:
#        (1) are cloned from the first member, 
#        (2) use the executable and SourceMods from the first member.
# ===================================================================================
# ===================================================================================
else

  echo "creating clone"
  $CESMROOT/cime/scripts/create_clone --case $CASEROOT --clone $masterroot --keepexe
  cd $CASEROOT
  ./xmlchange DOUT_S_ROOT=/glade/scratch/nanr/archive/$CASENAME

 #echo     /glade/scratch/nanr/archive/${USE_REFCASE}/rest/2015-01-01-00000/rpointer* /glade/scratch/nanr/${CASENAME}/run/
 #echo  /glade/scratch/nanr/archive/${USE_REFCASE}/rest/2015-01-01-00000/b.e21.BHISTcmip6.* /glade/scratch/nanr/${CASENAME}/run/
  cp     /glade/scratch/nanr/archive/${USE_REFCASE}/rest/2015-01-01-00000/rpointer* /glade/scratch/nanr/${CASENAME}/run/
  ln -s  /glade/scratch/nanr/archive/${USE_REFCASE}/rest/2015-01-01-00000/b.e21.BHISTcmip6.* /glade/scratch/nanr/${CASENAME}/run/

  ./xmlchange RUN_REFCASE=${USE_REFCASE}
  ./xmlchange GET_REFCASE=FALSE

  ./preview_namelists
endif

end             # member loop

exit

